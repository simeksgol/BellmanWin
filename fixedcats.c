#include "universe.h"

#define YES 1
#define NO 0

// Static pattern will match an allowed catalyzer if:
// 0 = Is On, Off or Unknown
// 1 = Is On or Unknown
// 2 = Is Off
// 4 = Is Off or Unknown

static int block [4] [6] [6] = 
{{{0, 4, 2, 2, 4, 0},
  {4, 4, 4, 4, 4, 4},
  {4, 4, 1, 1, 4, 4},
  {4, 4, 1, 1, 4, 4},
  {4, 4, 4, 4, 4, 4},
  {0, 4, 4, 4, 4, 0}},

 {{0, 4, 4, 4, 4, 0},
  {4, 4, 4, 4, 4, 4},
  {4, 4, 1, 1, 4, 4},
  {4, 4, 1, 1, 4, 4},
  {4, 4, 4, 4, 4, 4},
  {0, 4, 2, 2, 4, 0}},
  
 {{0, 4, 4, 4, 4, 0},
  {4, 4, 4, 4, 4, 4},
  {2, 4, 1, 1, 4, 4},
  {2, 4, 1, 1, 4, 4},
  {4, 4, 4, 4, 4, 4},
  {0, 4, 4, 4, 4, 0}},
  
 {{0, 4, 4, 4, 4, 0},
  {4, 4, 4, 4, 4, 4},
  {4, 4, 1, 1, 4, 2},
  {4, 4, 1, 1, 4, 2},
  {4, 4, 4, 4, 4, 4},
  {0, 4, 4, 4, 4, 0}}};

static int tub_boat [4] [7] [7] = 
{{{0, 0, 4, 4, 4, 0, 0},
  {0, 2, 2, 4, 4, 4, 0},
  {4, 2, 4, 1, 4, 4, 4},
  {4, 4, 1, 4, 1, 4, 4},
  {4, 4, 4, 1, 1, 4, 4},
  {0, 4, 4, 4, 4, 4, 4},
  {0, 0, 4, 4, 4, 4, 0}},
  
 {{0, 0, 4, 4, 4, 4, 0},
  {0, 4, 4, 4, 4, 4, 4},
  {4, 4, 4, 1, 1, 4, 4},
  {4, 4, 1, 4, 1, 4, 4},
  {4, 2, 4, 1, 4, 4, 4},
  {0, 2, 2, 4, 4, 4, 0},
  {0, 0, 4, 4, 4, 0, 0}},

 {{0, 0, 4, 4, 4, 0, 0},
  {0, 4, 4, 4, 2, 2, 0},
  {4, 4, 4, 1, 4, 2, 4},
  {4, 4, 1, 4, 1, 4, 4},
  {4, 4, 1, 1, 4, 4, 4},
  {4, 4, 4, 4, 4, 4, 0},
  {0, 4, 4, 4, 4, 0, 0}},

 {{0, 4, 4, 4, 4, 0, 0},
  {4, 4, 4, 4, 4, 4, 0},
  {4, 4, 1, 1, 4, 4, 4},
  {4, 4, 1, 4, 1, 4, 4},
  {4, 4, 4, 1, 4, 2, 4},
  {0, 4, 4, 4, 2, 2, 0},
  {0, 0, 4, 4, 4, 0, 0}}};

static int eater1 [8] [7] [7] = 
{{{0, 4, 4, 4, 4, 0, 0},
  {4, 2, 4, 4, 4, 0, 0},
  {4, 4, 1, 1, 4, 4, 4},
  {4, 4, 1, 4, 4, 4, 4},
  {4, 4, 4, 1, 1, 4, 4},
  {0, 4, 4, 4, 4, 4, 4},
  {0, 0, 4, 4, 4, 4, 0}},
  
 {{0, 4, 4, 4, 4, 0, 0},
  {4, 2, 4, 4, 4, 4, 0},
  {4, 4, 1, 1, 4, 4, 4},
  {4, 4, 1, 4, 1, 4, 4},
  {4, 4, 4, 4, 1, 4, 4},
  {0, 0, 4, 4, 4, 4, 4},
  {0, 0, 4, 4, 4, 4, 0}},
  
 {{0, 0, 4, 4, 4, 4, 0},
  {0, 4, 4, 4, 4, 4, 4},
  {4, 4, 4, 1, 1, 4, 4},
  {4, 4, 1, 4, 4, 4, 4},
  {4, 4, 1, 1, 4, 4, 4},
  {4, 2, 4, 4, 4, 0, 0},
  {0, 4, 4, 4, 4, 0, 0}},
  
 {{0, 0, 4, 4, 4, 4, 0},
  {0, 0, 4, 4, 4, 4, 4},
  {4, 4, 4, 4, 1, 4, 4},
  {4, 4, 1, 4, 1, 4, 4},
  {4, 4, 1, 1, 4, 4, 4},
  {4, 2, 4, 4, 4, 4, 0},
  {0, 4, 4, 4, 4, 0, 0}},
  
 {{0, 0, 4, 4, 4, 4, 0},
  {0, 0, 4, 4, 4, 2, 4},
  {4, 4, 4, 1, 1, 4, 4},
  {4, 4, 4, 4, 1, 4, 4},
  {4, 4, 1, 1, 4, 4, 4},
  {4, 4, 4, 4, 4, 4, 0},
  {0, 4, 4, 4, 4, 0, 0}},
  
 {{0, 0, 4, 4, 4, 4, 0},
  {0, 4, 4, 4, 4, 2, 4},
  {4, 4, 4, 1, 1, 4, 4},
  {4, 4, 1, 4, 1, 4, 4},
  {4, 4, 1, 4, 4, 4, 4},
  {4, 4, 4, 4, 4, 0, 0},
  {0, 4, 4, 4, 4, 0, 0}},
  
 {{0, 4, 4, 4, 4, 0, 0},
  {4, 4, 4, 4, 4, 4, 0},
  {4, 4, 1, 1, 4, 4, 4},
  {4, 4, 4, 4, 1, 4, 4},
  {4, 4, 4, 1, 1, 4, 4},
  {0, 0, 4, 4, 4, 2, 4},
  {0, 0, 4, 4, 4, 4, 0}},
  
 {{0, 4, 4, 4, 4, 0, 0},
  {4, 4, 4, 4, 4, 0, 0},
  {4, 4, 1, 4, 4, 4, 4},
  {4, 4, 1, 4, 1, 4, 4},
  {4, 4, 4, 1, 1, 4, 4},
  {0, 4, 4, 4, 4, 2, 4},
  {0, 0, 4, 4, 4, 4, 0}}};
  

static int cat_cell (int *cat, int sym, int x, int y, int ht, int wd)
{
  return cat [sym * ht * wd + y * wd + x];
}

static int could_be_part_of_cat (tile *t, int x, int y, int *cat, int symcnt, int ht, int wd)
{
	int symi;
	int my;
	int mx;
	int cy;
	int cx;
	
	for (symi = 0; symi < symcnt; symi++)
		for (my = 0; my < ht; my++)
			for (mx = 0; mx < wd; mx++)
				if (cat_cell (cat, symi, mx, my, ht, wd) == 1)
				{
					int match = YES;
					for (cy = 0; cy < ht; cy++)
					{
						for (cx = 0; cx < wd; cx++)
						{
							int pst = tile_get_cell (t, x - mx + cx, y - my + cy);
							int tst = cat_cell (cat, symi, cx, cy, ht, wd);
							if (tst == 0)
								continue;
							else if (tst == 1)
							{
								if (pst == ON || pst == UNKNOWN_STABLE)
									continue;
							}
							else if (tst == 2)
							{
								if (pst == OFF)
									continue;
							}
							else if (tst == 4)
							{
								if (pst == OFF || pst == UNKNOWN_STABLE)
									continue;
							}
							
							match = NO;
							break;
						}
						if (!match)
							break;
					}
					if (match)
						return YES;
				}
	
	return NO;
}

int ver_cats (generation *ge)
{
	tile *t = ge->all_first->auxdata;
	
	int y;
	int x;
	
	for (y = 8; y < TILE_HEIGHT - 8; y++)
		for (x = 8; x < TILE_WIDTH - 8; x++)
			if (tile_get_cell (t, x, y) == ON)
				if (!could_be_part_of_cat (t, x, y, (int *) block, 4, 6, 6) &&
					!could_be_part_of_cat (t, x, y, (int *) tub_boat, 4, 7, 7) &&
					!could_be_part_of_cat (t, x, y, (int *) eater1, 8, 7, 7))
						return NO;
	return YES;
}
